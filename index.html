<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1600, initial-scale=1.0">
  <title>Fragtbestilling & Kartoteker</title>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- (valgfri) XLSX bib som du allerede brugte -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1600px; margin: auto; }
    h1, h2 { margin-top: 30px; }
    .bestiller-container { margin-bottom: 20px; }
    .bestiller-container label { font-weight: bold; margin-right: 10px; }

    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background: #f0f0f0; }
    tbody td { vertical-align: middle; }

    input, select, button { box-sizing: border-box; padding: 4px; font-family: inherit; }
    input[type="text"], input[type="number"], select, input[type="date"], input[type="time"] { width: 100%; }

    .checkbox-cell { text-align: center; }
    .add-row-btn, .delete-row-btn { padding: 1px 3px; font-size: 0.5em; cursor: pointer; border-radius: 4px; }
    .add-row-btn { background: #3498db; color: white; }
    .delete-row-btn { background: #e74c3c; color: white; }
    .delete-row-btn[disabled] { background: #ccc; color: #999; cursor: not-allowed; }
    .action-buttons { margin-top: 20px; display: flex; gap: 10px; }
    .action-buttons button { padding: 6px 12px; font-size: 1em; }

    .modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 9999; }
    .modal-content { background: white; padding: 24px; border-radius: 10px; max-width: 98vw; width: 98vw; height: 95vh; overflow:auto;}
    .customer-list table { font-size: 1.1em; width: 100%; }
    .customer-list th, .customer-list td { padding: 10px 6px; }
    .customer-list th[data-key="info"], .customer-list td[data-key="info"] { min-width: 320px; width: 340px; }
    .radio-cell { text-align: center; }
    .editCust-btn, .saveEdit-btn, .cancelEdit-btn { margin-right: 4px; font-size: 0.85em; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; }
    .close-btn { background: #e74c3c; color: #fff; border: none; font-size: 1.1em; font-weight: bold; border-radius: 6px; padding: 10px 28px; cursor: pointer; transition: background 0.2s; margin-left: 10px; }
    .close-btn:hover { background: #c0392b; }

    th:nth-child(2), td:nth-child(2) { width: 90px; min-width: 70px; max-width: 120px; }
    th:nth-child(3), td:nth-child(3),
    th:nth-child(4), td:nth-child(4) { width: 340px; min-width: 260px; max-width: 400px; }
    th:nth-child(5), td:nth-child(5),
    th:nth-child(7), td:nth-child(7),
    th:nth-child(8), td:nth-child(8) { width: 68px; min-width: 55px; max-width: 90px; }
    th:nth-child(6), td:nth-child(6) { width: 136px; min-width: 110px; max-width: 200px; }
    th:nth-child(9), td:nth-child(9) { width: 85px; min-width: 55px; max-width: 110px; text-align:center;}
    th:nth-child(10), td:nth-child(10) { width: 180px; min-width: 120px; max-width: 250px; }
    th:nth-child(11), td:nth-child(11) { width: 85px; min-width: 65px; max-width: 120px; text-align: center; }

    .inline-field { display: flex; align-items: center; gap: 8px; width: 100%; }
    .inline-field > input[type="checkbox"] { flex: 0 0 auto; margin: 0; }
    .inline-field > select { flex: 1 1 auto; min-width: 0; }
  </style>
</head>
<body>
  <h1>Fragtbestilling</h1>

  <div class="bestiller-container">
    <label for="bestillerSelect">Bestiller:</label>
    <select id="bestillerSelect"></select>
  </div>

  <table id="bookingTable">
    <thead>
      <tr>
        <th></th><th>Klartid</th><th>Afsender</th><th>Modtager</th><th>Antal</th><th>Type</th><th>LDM</th><th>Vægt</th><th>Afhentet</th><th>Pris (DKK)</th><th>Afregnet</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td class="checkbox-cell"><button class="add-row-btn">+</button><button class="delete-row-btn">−</button></td>
        <td><input type="date" class="datepicker"><input type="time" class="timepicker"></td>

        <td>
          <div class="inline-field">
            <input type="checkbox" class="copyBestSender" checked>
            <select class="afsender"></select>
          </div>
        </td>

        <td>
          <div class="inline-field">
            <input type="checkbox" class="copyBestReceiver">
            <select class="modtager"></select>
          </div>
        </td>

        <td><input type="number" min="1" class="antal"></td>
        <td><select class="typeSelect"></select></td>
        <td><input type="number" step="0.01" class="ldm"></td>
        <td><input type="number" step="0.01" class="vægt"></td>
        <td class="checkbox-cell"><input type="checkbox" class="afhentet"></td>

        <td style="position:relative;">
          <input type="text" inputmode="decimal" class="pris" placeholder="0,00 kr" style="padding-right:40px;text-align:right;">
          <span style="position:absolute;right:10px;top:50%;transform:translateY(-50%);pointer-events:none;color:#888;font-size:0.92em;">kr</span>
        </td>
        <td class="checkbox-cell"><input type="checkbox" class="afregnet"></td>
      </tr>
    </tbody>
  </table>

  <div class="action-buttons">
    <button id="create">Opret bestilling</button>
    <button id="manageCustomers">Kunder</button>
    <button id="createType">Opret type</button>
  </div>

  <!-- Customer Management Modal -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Administrer kunder</h2>
        <button id="closeModal" class="close-btn">Luk vindue</button>
      </div>
      <div style="margin-bottom:14px;display:flex;gap:10px;align-items:center;">
        <button id="exportJson">Eksporter JSON</button>
        <button id="exportCsv">Eksporter CSV</button>
        <label style="display:inline-block;">
          <input type="file" id="importCustomers" accept=".json,.csv" style="display:none;">
          <span id="importLabel" style="padding:6px 10px;border:1px solid #888;border-radius:4px;cursor:pointer; background:#f3f3f3;">Importer</span>
        </label>
      </div>
      <button id="addNewCustomer">+</button>
      <div class="customer-list">
        <table id="customerListTable">
          <thead><tr>
            <th data-key="name">Navn</th>
            <th data-key="street">Vejnavn</th>
            <th data-key="number">Nr</th>
            <th data-key="zip">Postnr</th>
            <th data-key="city">By</th>
            <th data-key="email">Mail</th>
            <th data-key="phone">Tlfnr</th>
            <th data-key="info">Info</th>
            <th>Standard bestiller</th>
            <th>Handling</th>
          </tr></thead>
          <tbody id="customerTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    /* ========= Supabase opsætning ========= */
    const SUPABASE_URL = "https://btbwkwcywofvwguouvpg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ0Yndrd2N5d29mdndndW91dnBnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ3NzA3NDYsImV4cCI6MjA3MDM0Njc0Nn0.HMqGy_bwfH8m-Im06zYchDCfYNZBtWm2aAX-54yQqOg";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ét fælles "workspace" så alle ser samme tabel
    const WORKSPACE_ID = "default";

    /* ========= Lokal state (bevarer din struktur) ========= */
    let customers = JSON.parse(localStorage.getItem('customers')||'[]');
    customers.forEach(c=>c.id = c.id || (Date.now().toString()+Math.random()));
    localStorage.setItem('customers',JSON.stringify(customers));

    let types     = JSON.parse(localStorage.getItem('types')||'[]');
    window.editRow = null;

    function getDefaultBestillerId() { return localStorage.getItem('defaultBestillerId') || null; }
    function setDefaultBestillerId(id) { if (id) localStorage.setItem('defaultBestillerId', id); else localStorage.removeItem('defaultBestillerId'); }

    /* ========= Hjælpere ========= */
    function formatNumberDK(n){
      if(n===null || n===undefined || isNaN(n)) return "";
      return Number(n).toLocaleString('da-DK', {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function parseDK(val){
      if(!val) return null;
      let v = String(val).replace(/\./g,'').replace(',','.');
      let n = parseFloat(v);
      return isNaN(n)? null : n;
    }
    function debounce(fn, ms=500){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    /* ========= Sync selectfelter (uforandret logik) ========= */
    function syncSelects() {
      let defaultBestillerId = getDefaultBestillerId();
      let bestillerSel = document.getElementById('bestillerSelect');
      if (bestillerSel) {
        bestillerSel.innerHTML = '<option value=""></option>';
        customers.forEach((c) => {
          let opt = document.createElement('option');
          opt.value = c.id || '';
          opt.text  = `${c.name}, ${c.street} ${c.number}, ${c.zip} ${c.city}`;
          if (defaultBestillerId && c.id === defaultBestillerId) opt.selected = true;
          bestillerSel.append(opt);
        });
        bestillerSel.onchange = function() {
          let id = this.value;
          let kunde = customers.find(c => c.id === id);
          document.querySelectorAll('.afsender').forEach(sel => {
            let sChk = sel.closest('tr').querySelector('.copyBestSender');
            if (sChk && sChk.checked && kunde) {
              sel.value = `${kunde.name} ${kunde.street} ${kunde.number} ${kunde.zip} ${kunde.city}`;
            }
          });
          scheduleBookingsSave();
        };
      }
      document.querySelectorAll('.afsender, .modtager').forEach(sel=>{
        sel.innerHTML = '<option value=""></option>';
        customers.forEach(c => {
          let opt = document.createElement('option');
          opt.value = `${c.name} ${c.street} ${c.number} ${c.zip} ${c.city}`;
          opt.text  = `${c.name}, ${c.street} ${c.number}, ${c.zip} ${c.city}`;
          sel.append(opt);
        });
      });
      document.querySelectorAll('.typeSelect').forEach(sel=>{
        sel.innerHTML = '<option value=""></option>';
        types.forEach(t=>{
          let opt = document.createElement('option');
          opt.value = t.code;
          opt.text  = t.code;
          sel.append(opt);
        });
      });
    }

    /* ========= Modal håndtering (uforandret UI) ========= */
    const modal = document.getElementById('customerModal');
    document.getElementById('manageCustomers').onclick = () => { renderCustomerList(); modal.style.display = 'flex'; };
    document.getElementById('closeModal').onclick = () => modal.style.display = 'none';
    window.onclick = e => { if(e.target===modal) modal.style.display='none'; };

    async function renderCustomerList() {
      function sortTable(key) {
        const th = document.querySelector(`#customerListTable th[data-key="${key}"]`);
        const asc = !th.classList.contains('sort-asc');
        document.querySelectorAll('#customerListTable th').forEach(h=>h.classList.remove('sort-asc','sort-desc'));
        th.classList.add(asc? 'sort-asc':'sort-desc');
        customers.sort((a,b)=>(asc ? a[key].toString().localeCompare(b[key].toString()) : b[key].toString().localeCompare(a[key].toString())));
        window.editRow = null;
        renderCustomerList();
        syncSelects();
      }
      const tbody = document.getElementById('customerTableBody');
      tbody.innerHTML = '';
      let defaultBestillerId = getDefaultBestillerId();

      customers.forEach((c,i) => {
        let tr = document.createElement('tr');
        if (window.editRow === i) {
          tr.innerHTML = `
            <td><input type="text" value="${c.name||""}" id="editName"></td>
            <td><input type="text" value="${c.street||""}" id="editStreet"></td>
            <td><input type="text" value="${c.number||""}" id="editNumber"></td>
            <td><input type="text" value="${c.zip||""}" id="editZip"></td>
            <td><input type="text" value="${c.city||""}" id="editCity"></td>
            <td><input type="email" value="${c.email||""}" id="editEmail"></td>
            <td><input type="tel" value="${c.phone||""}" id="editPhone"></td>
            <td><textarea id="editInfo" rows="6" style="width:99%;">${c.info||""}</textarea></td>
            <td class="radio-cell"><input type="radio" name="defaultBestiller" value="${c.id}" ${defaultBestillerId == c.id ? 'checked' : ''}></td>
            <td><button class="saveEdit-btn">Gem</button><button class="cancelEdit-btn">Annuller</button></td>`;
        } else {
          tr.innerHTML = `
            <td>${c.name||""}</td><td>${c.street||""}</td><td>${c.number||""}</td><td>${c.zip||""}</td>
            <td>${c.city||""}</td><td>${c.email||""}</td><td>${c.phone||""}</td>
            <td data-key="info" style="max-width:340px;white-space:pre-wrap;">${c.info||""}</td>
            <td class="radio-cell"><input type="radio" name="defaultBestiller" value="${c.id}" ${defaultBestillerId == c.id ? 'checked' : ''}></td>
            <td><button data-index="${i}" class="editCust-btn">Rediger</button><button data-index="${i}" class="deleteCust-btn">−</button></td>`;
        }
        tbody.append(tr);
      });

      document.querySelectorAll('.deleteCust-btn').forEach(btn => btn.onclick = async ()=>{
        const idx = btn.dataset.index;
        const deleted = customers[idx];
        customers.splice(idx,1);
        localStorage.setItem('customers', JSON.stringify(customers));
        if(deleted && getDefaultBestillerId() === deleted.id) setDefaultBestillerId(null);
        syncSelects();
        window.editRow = null;
        renderCustomerList();
        await saveCustomersToSupabase(); // gem ændringen
      });
      document.querySelectorAll('.editCust-btn').forEach(btn => btn.onclick = ()=>{ window.editRow = Number(btn.dataset.index); renderCustomerList(); });
      document.querySelectorAll('.saveEdit-btn').forEach(btn => btn.onclick = async ()=>{
        const i = window.editRow;
        customers[i].name   = document.getElementById('editName').value;
        customers[i].street = document.getElementById('editStreet').value;
        customers[i].number = document.getElementById('editNumber').value;
        customers[i].zip    = document.getElementById('editZip').value;
        customers[i].city   = document.getElementById('editCity').value;
        customers[i].email  = document.getElementById('editEmail').value;
        customers[i].phone  = document.getElementById('editPhone').value;
        customers[i].info   = document.getElementById('editInfo').value;
        localStorage.setItem('customers', JSON.stringify(customers));
        syncSelects(); window.editRow = null; renderCustomerList();
        await saveCustomersToSupabase();
      });
      document.querySelectorAll('.cancelEdit-btn').forEach(btn => btn.onclick = ()=>{ window.editRow = null; renderCustomerList(); });
      document.querySelectorAll('#customerListTable th[data-key]').forEach(th=>th.onclick = ()=> sortTable(th.dataset.key));
      document.querySelectorAll('input[name=defaultBestiller]').forEach(radio => {
        radio.onchange = ()=>{ setDefaultBestillerId(radio.value); syncSelects(); renderCustomerList(); };
      });
    }

    document.getElementById('addNewCustomer').onclick = ()=>{
      // bevarer din eksisterende funktionalitet:
      let w = window.open('customer_form.html','_blank');
      let iv = setInterval(async ()=>{
        let newList = JSON.parse(localStorage.getItem('customers')||'[]');
        if(newList.length !== customers.length) {
          customers = newList;
          syncSelects(); renderCustomerList();
          clearInterval(iv);
          await saveCustomersToSupabase();
        }
      }, 500);
    };

    document.getElementById('createType').onclick = ()=>{
      let code = prompt('Typekode:'); let desc = prompt('Beskrivelse:');
      if(code && desc!==null) { types.push({ code, desc }); localStorage.setItem('types', JSON.stringify(types)); syncSelects(); }
    };

    /* ========= Booking-række logik (uforandret UI, tilføjet autosave) ========= */
    const tbodyBooking = document.querySelector('#bookingTable tbody');

    function lockRow(row, locked) {
      row.querySelectorAll('input,select,textarea').forEach(input=>{
        if (input.classList.contains('pris') || input.classList.contains('afregnet') || input.classList.contains('afhentet')) {
          input.disabled = false;
        } else {
          input.disabled = !!locked;
        }
      });
      let delBtn = row.querySelector('.delete-row-btn');
      if (delBtn) delBtn.disabled = !!locked;
    }

    function setupRow(row) {
      let afhentet = row.querySelector('.afhentet');
      let delBtn = row.querySelector('.delete-row-btn');
      delBtn.style.display = row===tbodyBooking.rows[0]? 'none':'inline-block';
      delBtn.onclick = ()=>{ row.remove(); scheduleBookingsSave(); };

      row.querySelector('.add-row-btn').onclick = ()=>{
        let nr = row.cloneNode(true);
        nr.querySelectorAll('input').forEach(i=> i.type==='checkbox'? i.checked=i.classList.contains('copyBestSender'): i.value='');
        row.after(nr); setupRow(nr); scheduleBookingsSave();
      };

      // autosave når der ændres i felter
      row.querySelectorAll('input,select').forEach(el=> {
        el.addEventListener('input', ()=>{ 
          if(row===tbodyBooking.lastElementChild) addRow();
          scheduleBookingsSave();
        });
        el.addEventListener('change', scheduleBookingsSave);
      });

      let sChk = row.querySelector('.copyBestSender');
      let sSel = row.querySelector('.afsender');
      if (sChk && sSel && sChk.checked) {
        let bestillerSel = document.getElementById('bestillerSelect');
        let id = bestillerSel.value; let kunde = customers.find(c => c.id === id);
        if(kunde) sSel.value = `${kunde.name} ${kunde.street} ${kunde.number} ${kunde.zip} ${kunde.city}`;
      }
      if (sChk && sSel) {
        sChk.onchange = ()=>{
          if(sChk.checked) {
            let id = document.getElementById('bestillerSelect').value;
            let kunde = customers.find(c => c.id === id);
            if(kunde) sSel.value = `${kunde.name} ${kunde.street} ${kunde.number} ${kunde.zip} ${kunde.city}`;
            scheduleBookingsSave();
          }
        };
      }
      let rChk = row.querySelector('.copyBestReceiver');
      let rSel = row.querySelector('.modtager');
      if (rChk && rSel) {
        rChk.onchange = ()=>{
          if(rChk.checked) {
            let id = document.getElementById('bestillerSelect').value;
            let kunde = customers.find(c => c.id === id);
            if(kunde) rSel.value = `${kunde.name} ${kunde.street} ${kunde.number} ${kunde.zip} ${kunde.city}`;
            scheduleBookingsSave();
          }
        };
      }

      // Pris: DK-format i feltet
      let pris = row.querySelector('.pris');
      if(pris){
        pris.addEventListener('blur', function() {
          let num = parseDK(this.value);
          this.value = (num===null) ? "" : `${formatNumberDK(num)}`;
        });
        pris.addEventListener('focus', function() {
          let num = parseDK(this.value);
          if(num!==null) this.value = String(num).replace('.',',');
        });
      }

      if(afhentet){
        afhentet.onchange = function() { lockRow(row, afhentet.checked); scheduleBookingsSave(); };
        lockRow(row, afhentet.checked);
      }
    }

    function addRow() {
      let nr = tbodyBooking.rows[tbodyBooking.rows.length-1].cloneNode(true);
      nr.querySelectorAll('input').forEach(i=> i.type==='checkbox'? i.checked=i.classList.contains('copyBestSender'): i.value='');
      tbodyBooking.append(nr); setupRow(nr);
    }
    setupRow(tbodyBooking.rows[0]);

    document.getElementById('create').onclick = ()=>alert('Bestilling gemt!');

    // Eksport / import kunder (tilføjet save til Supabase)
    document.getElementById('exportJson').onclick = function() {
      const blob = new Blob([JSON.stringify(customers, null, 2)], {type: 'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kunder.json'; a.click();
    };
    document.getElementById('exportCsv').onclick = function() {
      let headers = ["Navn","Vejnavn","Nr","Postnr","By","Mail","Tlfnr","Info"];
      let rows = customers.map(c => [c.name, c.street, c.number, c.zip, c.city, c.email, c.phone, (c.info||"").replace(/[\r\n]+/g," ")]);
      let csv = [headers, ...rows].map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(";")).join("\r\n");
      const blob = new Blob([csv], {type:'text/csv'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kunder.csv'; a.click();
    };
    document.getElementById('importLabel').onclick = function() { document.getElementById('importCustomers').click(); };
    document.getElementById('importCustomers').onchange = async function(evt) {
      const file = evt.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = async function(e) {
        let imported = [];
        try {
          if(file.name.match(/\.json$/i)) {
            imported = JSON.parse(e.target.result);
          } else if(file.name.match(/\.csv$/i)) {
            let lines = e.target.result.split(/\r?\n/); lines.shift();
            imported = lines.filter(l=>l.trim()).map(line=>{
              let m = line.match(/("([^"]|"")*"|[^;]*)(;|$)/g) || [];
              let vals = m.map(s=>s.replace(/^"|"$/g,'').replace(/""/g,'"').replace(/;$/,''));
              let o = {}; ["name","street","number","zip","city","email","phone","info"].forEach((k,i)=>o[k]=vals[i]||"");
              o.id = Date.now().toString()+Math.random(); return o;
            });
          }
        } catch(e){ alert("Kunne ikke importere data. Tjek filformat."); return; }
        if(imported.length && imported[0].name && imported[0].street) {
          customers = imported; localStorage.setItem('customers', JSON.stringify(customers));
          syncSelects(); renderCustomerList(); alert("Kunder importeret.");
          await saveCustomersToSupabase();
        } else { alert("Filen indeholder ikke genkendelige kunder."); }
        evt.target.value = "";
      };
      reader.readAsText(file);
    };

    /* ========= Supabase: Kunder ========= */
    async function loadCustomersFromSupabase(){
      const { data, error } = await supabase
        .from('customers')
        .select('*')
        .order('created_at', { ascending: true });
      if(error){ console.warn('Kunne ikke indlæse kunder:', error.message); return; }
      if(Array.isArray(data) && data.length){
        customers = data.map(row => ({
          id: row.id || (Date.now().toString()+Math.random()),
          name: row.name||'',
          street: row.street||'',
          number: row.number||'',
          zip: row.zip||'',
          city: row.city||'',
          email: row.email||'',
          phone: row.phone||'',
          info: row.info||''
        }));
        localStorage.setItem('customers', JSON.stringify(customers));
      }
    }

    async function saveCustomersToSupabase(){
      // nem strategi: slet alle og indsæt snapshot (kræver RLS-policy der tillader delete/insert)
      const snapshot = customers.map(c=>({
        id: c.id, // antager text/uuid – hvis uuid i DB, kan DB selv generere hvis null
        name: c.name||'',
        street: c.street||'',
        number: c.number||'',
        zip: c.zip||'',
        city: c.city||'',
        email: c.email||'',
        phone: c.phone||'',
        info: c.info||''
      }));
      // slet alle
      await supabase.from('customers').delete().neq('id', null);
      if(snapshot.length){
        const { error } = await supabase.from('customers').insert(snapshot);
        if(error) console.warn('Fejl ved gem kunder:', error.message);
      }
    }

    /* ========= Supabase: Bookings ========= */
    function getBookingsSnapshot(){
      const rows = Array.from(tbodyBooking.querySelectorAll('tr'));
      return rows.map((tr, idx) => {
        const date = tr.querySelector('.datepicker')?.value || '';
        const time = tr.querySelector('.timepicker')?.value || '';
        const afsender = tr.querySelector('.afsender')?.value || '';
        const modtager = tr.querySelector('.modtager')?.value || '';
        const antal = tr.querySelector('.antal')?.value || '';
        const type = tr.querySelector('.typeSelect')?.value || '';
        const ldm = tr.querySelector('.ldm')?.value || '';
        const vaegt = tr.querySelector('.vægt')?.value || '';
        const afhentet = tr.querySelector('.afhentet')?.checked || false;
        const prisVal = tr.querySelector('.pris')?.value || '';
        const pris = parseDK(prisVal);
        const afregnet = tr.querySelector('.afregnet')?.checked || false;

        return {
          workspace: WORKSPACE_ID,
          row_index: idx,
          klart_dato: date || null,
          klart_tid: time || null,
          afsender, modtager,
          antal: antal? Number(antal): null,
          type_code: type || null,
          ldm: ldm? Number(ldm): null,
          vaegt: vaegt? Number(vaegt): null,
          afhentet,
          pris: pris,   // numeric
          afregnet
        };
      });
    }

    async function loadBookingsFromSupabase(){
      const { data, error } = await supabase
        .from('bookings')
        .select('*')
        .eq('workspace', WORKSPACE_ID)
        .order('row_index', { ascending: true });
      if(error){ console.warn('Kunne ikke indlæse bookings:', error.message); return; }
      if(!Array.isArray(data)) return;
      // ryd alt undtagen første skabelonrække
      const first = tbodyBooking.querySelector('tr');
      tbodyBooking.innerHTML = '';
      tbodyBooking.append(first);
      // udfyld
      data.forEach((r, i) => {
        const tr = (i===0) ? first : first.cloneNode(true);
        const setVal = (sel, v)=>{ if(sel){ sel.value = (v??''); } };
        const setChk = (sel, v)=>{ if(sel){ sel.checked = !!v; } };

        setVal(tr.querySelector('.datepicker'), r.klart_dato || '');
        setVal(tr.querySelector('.timepicker'), r.klart_tid || '');
        setVal(tr.querySelector('.afsender'), r.afsender || '');
        setVal(tr.querySelector('.modtager'), r.modtager || '');
        setVal(tr.querySelector('.antal'), r.antal ?? '');
        setVal(tr.querySelector('.typeSelect'), r.type_code || '');
        setVal(tr.querySelector('.ldm'), r.ldm ?? '');
        setVal(tr.querySelector('.vægt'), r.vaegt ?? '');
        setChk(tr.querySelector('.afhentet'), r.afhentet);
        setVal(tr.querySelector('.pris'), r.pris==null? '' : formatNumberDK(r.pris));
        setChk(tr.querySelector('.afregnet'), r.afregnet);

        if(i>0) tbodyBooking.append(tr);
        setupRow(tr);
      });
    }

    async function saveBookingsToSupabase(){
      const snapshot = getBookingsSnapshot();
      // slet alt i workspace og indsæt snapshot
      const { error: delErr } = await supabase.from('bookings').delete().eq('workspace', WORKSPACE_ID);
      if(delErr){ console.warn('Fejl ved slet bookings:', delErr.message); return; }
      if(snapshot.length){
        const { error: insErr } = await supabase.from('bookings').insert(snapshot);
        if(insErr) console.warn('Fejl ved gem bookings:', insErr.message);
      }
    }
    const scheduleBookingsSave = debounce(saveBookingsToSupabase, 600);

    /* ========= Init ========= */
    window.addEventListener('DOMContentLoaded', async () => {
      // 1) Indlæs kunder fra Supabase, sync selects
      await loadCustomersFromSupabase();
      syncSelects();

      // 2) Sæt default bestiller og sæt afsender hvis nødvendigt
      let bestillerSel = document.getElementById('bestillerSelect');
      let defaultBestillerId = getDefaultBestillerId();
      if(defaultBestillerId && customers.find(c=>c.id===defaultBestillerId) && bestillerSel) {
        bestillerSel.value = defaultBestillerId;
        let kunde = customers.find(c=>c.id===defaultBestillerId);
        document.querySelectorAll('.afsender').forEach(sel => {
          let sChk = sel.closest('tr').querySelector('.copyBestSender');
          if (sChk && sChk.checked && kunde) sel.value = `${kunde.name} ${kunde.street} ${kunde.number} ${kunde.zip} ${kunde.city}`;
        });
      }

      // 3) Indlæs bookingrækker fra Supabase
      await loadBookingsFromSupabase();

      // 4) Autosave hvert minut + ved luk
      setInterval(saveBookingsToSupabase, 60*1000);
      window.addEventListener('beforeunload', (e)=>{ navigator.sendBeacon && navigator.sendBeacon; /* best try */ });
      window.addEventListener('pagehide', saveBookingsToSupabase);
      window.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveBookingsToSupabase(); });
    });
  </script>
</body>
</html>
